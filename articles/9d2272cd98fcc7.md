---
title: "JavaScript: あとから個別に `await` することで並列化しようとしてはいけない"
emoji: "🍣"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["javascript", "concurrent", "parallel"]
published: false
---

## TL;DR

- 並列化するときは [`Promise.all(...)`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/all) を使います。
- 複数の Promise を取り扱うときは上記含めた、 [`.race(...)`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/race), [`.any(...)`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/race), [`.allSettled(...)`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled) の使用を検討します。

## 解説

以下は Deno と Node で動かして試せるようにしています。

```js
// 実際には API 叩いたりとか
const get = async (a, b) => new Promise(r => setTimeout(() => r(a + b), 100));
// 実際には例外が投げられうる処理
const err = async () => {throw new Error('err')};
// これでもいい
// const err = async () => new Promise((_, j) => setTimeout(() => j(new Error("err")), 0));

async function main () {
  const prom1 = get(1, 2);
  const prom2 = err();
  const prom3 = get(2, 3);

  // 並列化している
  await prom1;
  await prom2;
  await prom3;
}

try {
  await main();
} catch (e) {
  console.log('catch!', e);
}
```

これを実行すると、Node では `UnhandledPromiseRejectionWarning`, Deno では `Uncaught (in promise) Error:` となります。

これは `prom1` を `await` している間に `prom2` が例外を投げて _Rejected_ に移行しますが、

## 経緯


